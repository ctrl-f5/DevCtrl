<?php /** @var $this \Ctrl\View\PhpView */ ?>
<?php $project = $this->project     /** @var $project   \DevCtrl\Domain\Project */ ?>
<?php $types = $this->itemTypes;    /** @var $types     \DevCtrl\Domain\Item\Type\Type[] */ ?>
<?php $backlog = $this->backlog;   /** @var $backlog   \DevCtrl\Domain\Item\Item[] */ ?>
<?php echo $this->pageTitle('Project', $this->project->getName()); ?>

<?php $this->page = 'backlog'; ?>
<?php echo $this->render('dev-ctrl/project/partial/project-tabs.phtml'); ?>

<div class="btn-group">
    <a class="btn dropdown-toggle btn-primary" data-toggle="dropdown" href="#">
        New item
        <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
        <?php foreach ($types as $t): ?>
        <li><a href="<?php echo $this->url('item_create', array(
            'type' => $t->getId(),
            'project' => $project->getId()
        )); ?>"><?php echo $t->getName(); ?></a></li>
        <?php endforeach; ?>
    </ul>
</div>
<p></p>

<?php foreach ($backlog as $i): ?>
<?php $detailUrl = $this->url('default/id', array('controller' => 'item', 'action' => 'detail', 'id' => $i->getId())); ?>
<div class="container-fluid well" style="padding: 5px;">
    <div class="row-fluid">
        <div class="span1">
            <canvas class="ctrljs-3stage-gauge" guage-value="<?php echo $i->getProgress(); ?>" width="50" height="50"></canvas>
        </div>
        <div class="span11">
            <div class="row">
                <div class="span1">
                    <a href="<?php echo $detailUrl; ?>">
                        #<?php echo $i->getId(); ?>
                    </a>
                </div>
                <div class="span9">
                    <div class="btn-group">
                    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                        <?php echo $i->getTitle(); ?>
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="<?php echo $detailUrl; ?>">detail</a></li>
                        <li><a href="<?php echo $this->url('default/id', array('controller' => 'item', 'action' => 'edit', 'id' => $i->getId())); ?> ?>">edit</a></li>
                        <li><a href="<?php echo $detailUrl; ?>">assign to me</a></li>
                    </ul>
                    </div>
                </div>
                <div class="span2">
                    <?php
                    if ($i->getItemType()->supportsTiming())
                        echo '<span class="icon-time"></span> '.
                            $i->getTimeCounter()->getExecuted().' / '.
                            $i->getTimeCounter()->getEstimated()
                    ?>
                </div>
            </div>
            <div class="row">
                <div class="span1">
                    <?php if ($i->getItemType()->hasStates()): ?>
                        <span class="label label-<?php
                            echo ($i->getState()->getNativeState() == $i->getState()->getNativeStates(\DevCtrl\Domain\Item\State\State::STATE_CLOSED)) ?
                                'inverse': 'success'; ?>"><?php echo $i->getState()->getLabel() ?></span>
                    <?php endif; ?>
                </div>
                <div class="span9">
                    <?php echo $i->getDescription(); ?>
                </div>
                <div class="span1">
                    <?php echo $this->formatDate($i->getDateCreated(), 'Y-m-d'); ?>
                </div>
            </div>
        </div>
    </div>
</div>
<?php endforeach; ?>

<script type="text/javascript">
$(function () {
    $('.well .btn-group a.btn.dropdown-toggle').on('mouseleave', function () {
        $(this).removeClass('btn btn-mini dropdown-toggle');
        $(this).find('span').hide();
    }).on('mouseover', function () {
        $(this).addClass('btn btn-mini dropdown-toggle');
        $(this).find('span').show();
    }).trigger('mouseleave');
});
</script>